{% extends "base.html" %}

{% block title %}{{ product.name }} | AutoShop{% endblock %}

{% block content %}
<main class="page-product">
  <div class="container">
    <!-- Product Info Section -->
    <section class="product-details-section">
      <div class="product-image-container">
        <img src="{{ url_for('static', path='/img/products/' + (product.image or 'default.jpg')) }}" alt="{{ product.name }}" class="product-image">
      </div>
      <div class="product-info-column">
        <div class="product-title-price">
          <h1 class="product-name">{{ product.name }}</h1>
          <div class="price-section">
            <span class="price-tag">per unit</span>
            <p class="product-price">${{ "%.2f"|format(product.price) }}</p>
          </div>
        </div>
        <div class="product-description">
          <p>{{ product.description }}</p>
        </div>
        <div class="product-stock">
          {% if product.stock > 0 %}
            <p class="stock-info">In stock: {{ product.stock }} units</p>
          {% else %}
            <p class="stock-info stock-info--out">Out of stock</p>
          {% endif %}
        </div>
        <div class="cart-controls">
          {% if product.stock > 0 %}
          <form method="post" action="{{ url_for('product_add_to_cart', slug=product.slug) }}" class="add-to-cart-form">
            <div style="display: flex; gap: 12px; align-items: center;">
              <input type="number" name="quantity" value="1" min="1" max="{{ product.stock }}" style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <button type="submit" class="button button--primary add-to-cart-button">
                <i class="fa-solid fa-cart-shopping"></i>
                <span>Add to Cart</span>
              </button>
            </div>
          </form>
          {% else %}
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <button class="button button--primary" disabled style="opacity: 0.6; cursor: not-allowed;">
              <i class="fa-solid fa-times-circle"></i>
              <span>Out of Stock</span>
            </button>
            <a href="{{ url_for('catalog') }}" class="button button--secondary" style="text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <i class="fa-solid fa-arrow-left"></i>
              <span>Back to Catalog</span>
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Technical Specifications Accordion -->
    <section class="accordion-section">
      <div class="accordion-item">
        <div class="accordion-title">
          <h3>Technical Specifications</h3>
          <i class="fa-solid fa-chevron-down accordion-icon"></i>
        </div>
        <div class="accordion-content">
          <ul>
            <li><strong>Price:</strong> ${{ "%.2f"|format(product.price) }}</li>
            <li><strong>Stock:</strong> {{ product.stock }} units</li>
            <li><strong>SKU:</strong> {{ product.slug }}</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Reviews Section -->
    <section class="reviews-section">
      <div class="reviews-header">
        <h2 class="reviews-title">Customer Reviews</h2>
        {% if avg_rating and total_reviews > 0 %}
        <div class="average-rating">
          <div class="rating-number">{{ "%.1f"|format(avg_rating) }}</div>
          <div class="rating-stars">
            {% for i in range(5) %}
              {% if i < avg_rating|int %}
                <i class="fa-solid fa-star"></i>
              {% elif i < avg_rating %}
                <i class="fa-solid fa-star-half-stroke"></i>
              {% else %}
                <i class="fa-regular fa-star"></i>
              {% endif %}
            {% endfor %}
          </div>
          <div class="rating-count">Based on {{ total_reviews }} review{{ 's' if total_reviews != 1 else '' }}</div>
        </div>
        {% endif %}
      </div>

      {% if reviews %}
      <div class="reviews-list">
        {% for review in reviews %}
        <div class="review-item">
          <div class="review-header">
            <div class="review-author">
              <strong>{{ review.user.username if review.user else 'Anonymous' }}</strong>
              <div class="review-rating">
                {% for i in range(5) %}
                  {% if i < review.rating %}
                    <i class="fa-solid fa-star"></i>
                  {% else %}
                    <i class="fa-regular fa-star"></i>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
            <span class="review-date">{{ review.created_at.strftime('%Y-%m-%d') if review.created_at else '' }}</span>
          </div>
          <p class="review-comment">{{ review.comment }}</p>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="no-reviews">No reviews yet. Be the first to review this product!</p>
      {% endif %}

      {% if can_review %}
      <div class="review-form-container">
        <h3>Write a Review</h3>
        <form method="post" action="{{ url_for('product_add_review', slug=product.slug) }}" class="review-form">
          <div class="InputField">
            <label for="rating">Rating</label>
            <select name="rating" id="rating" required class="Input">
              <option value="">Select rating</option>
              <option value="5">5 - Excellent</option>
              <option value="4">4 - Very Good</option>
              <option value="3">3 - Good</option>
              <option value="2">2 - Fair</option>
              <option value="1">1 - Poor</option>
            </select>
          </div>
          <div class="InputField">
            <label for="comment">Comment (optional)</label>
            <textarea name="comment" id="comment" rows="5" class="Input" placeholder="Share your thoughts about this product..."></textarea>
          </div>
          <button type="submit" class="button button--primary">Submit Review</button>
        </form>
      </div>
      {% elif user_review %}
      <p class="review-note">You have already reviewed this product.</p>
      {% elif request.session.get('user_id') %}
      <p class="review-note">Purchase this product to leave a review.</p>
      {% else %}
      <p class="review-note">Please <a href="{{ url_for('login') }}">sign in</a> to write a review.</p>
      {% endif %}
    </section>
  </div>
</main>
{% endblock %}
