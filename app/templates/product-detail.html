{% extends "base.html" %}

{% block title %}{{ product.name }} | Hop & Barley{% endblock %}

{% block content %}
<main class="page-product">
  <div class="container">
    <!-- Product Info Section -->
    <section class="product-details-section">
      <div class="product-image-container">
        <img src="{{ url_for('static', path='/img/products/' + (product.image or 'default.jpg')) }}" alt="{{ product.name }}" class="product-image">
      </div>
      <div class="product-info-column">
        <div class="product-title-price">
          <h1 class="product-name">{{ product.name }}</h1>
          <div class="price-section">
            <span class="price-tag">per unit</span>
            <p class="product-price">${{ "%.2f"|format(product.price) }}</p>
          </div>
        </div>
        <div class="product-description">
          <p>{{ product.description }}</p>
        </div>
        <div class="product-stock">
          {% if product.stock > 0 %}
            <p class="stock-info">In stock: {{ product.stock }} units</p>
          {% else %}
            <p class="stock-info stock-info--out">Out of stock</p>
          {% endif %}
        </div>
        <div class="cart-controls">
          {% if product.stock > 0 %}
          <form method="post" action="{{ url_for('cart_add') }}" class="add-to-cart-form">
            <input type="hidden" name="product_id" value="{{ product.id }}">
            <input type="hidden" name="quantity" value="1" id="product-quantity">
            <button type="submit" class="button button--primary add-to-cart-button" id="add-to-cart-btn">
              <i class="fa-solid fa-cart-shopping"></i>
              <span>Add to Cart</span>
            </button>
          </form>
          <div class="quantity-counter is-hidden" id="quantity-counter">
            <form method="post" action="{{ url_for('cart_update') }}" class="quantity-form">
              <input type="hidden" name="product_id" value="{{ product.id }}">
              <button type="submit" name="action" value="decrease" class="quantity-btn" aria-label="Decrease quantity">
                <i class="fa-solid fa-minus"></i>
              </button>
              <span class="quantity-value">1 in cart</span>
              <button type="submit" name="action" value="increase" class="quantity-btn" aria-label="Increase quantity">
                <i class="fa-solid fa-plus"></i>
              </button>
            </form>
          </div>
          {% else %}
          <button class="button button--primary" disabled>Out of Stock</button>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Technical Specifications Accordion -->
    <section class="accordion-section">
      <div class="accordion-item">
        <div class="accordion-title">
          <h3>Technical Specifications</h3>
          <i class="fa-solid fa-chevron-down accordion-icon"></i>
        </div>
        <div class="accordion-content">
          <ul>
            <li><strong>Category:</strong> {{ product.category.name if product.category else 'N/A' }}</li>
            <li><strong>Price:</strong> ${{ "%.2f"|format(product.price) }}</li>
            <li><strong>Stock:</strong> {{ product.stock }} units</li>
            <li><strong>SKU:</strong> {{ product.slug }}</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Reviews Section -->
    <section class="reviews-section">
      <h2 class="reviews-title">Reviews</h2>

      {% if reviews %}
      <div class="reviews-list">
        {% for review in reviews %}
        <div class="review-item">
          <div class="review-header">
            <div class="review-author">
              <strong>{{ review.user.username if review.user else 'Anonymous' }}</strong>
              <div class="review-rating">
                {% for i in range(5) %}
                  {% if i < review.rating %}
                    <i class="fa-solid fa-star"></i>
                  {% else %}
                    <i class="fa-regular fa-star"></i>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
            <span class="review-date">{{ review.created_at.strftime('%Y-%m-%d') if review.created_at else '' }}</span>
          </div>
          <p class="review-comment">{{ review.comment }}</p>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="no-reviews">No reviews yet. Be the first to review this product!</p>
      {% endif %}

      {% if current_user and can_review %}
      <div class="review-form-container">
        <h3>Write a Review</h3>
        <form method="post" action="{{ url_for('product_review', slug=product.slug) }}" class="review-form">
          <div class="InputField">
            <label for="rating">Rating</label>
            <select name="rating" id="rating" required>
              <option value="">Select rating</option>
              <option value="5">5 - Excellent</option>
              <option value="4">4 - Very Good</option>
              <option value="3">3 - Good</option>
              <option value="2">2 - Fair</option>
              <option value="1">1 - Poor</option>
            </select>
          </div>
          <div class="InputField">
            <label for="comment">Comment</label>
            <textarea name="comment" id="comment" rows="5" required></textarea>
          </div>
          <button type="submit" class="button button--primary">Submit Review</button>
        </form>
      </div>
      {% elif current_user and not can_review %}
      <p class="review-note">You can only review products you have purchased.</p>
      {% else %}
      <p class="review-note">Please <a href="{{ url_for('login') }}">sign in</a> to write a review.</p>
      {% endif %}
    </section>
  </div>
</main>
{% endblock %}
